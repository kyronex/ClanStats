{% extends "base.html.twig" %}

{% block title %}Clan Stats{% endblock %}

{% block body %}

<div class="container mt-5">
    <!-- Zone d'affichage des réponses (ordre logique) -->
    <div id="response-clan-info-table" class="response-container"></div>
    <div id="response-tag-clan" class="response-container"></div>
    <div id="response-nom-clan-form" class="response-container"></div>
    <div id="response-historique-clan-war" class="response-container"></div>
    <div id="response-historique-clan-war-ex" class="response-container"></div>

    <!-- Formulaire de recherche -->
    <div id="react-clan-search" class="search-form-container"></div>
</div>
{% endblock %}
{% block javascripts %}
{{ parent() }}
<script>
	window.App = window.App || {};
	window.App.Tools = window.App.Tools || {};
	window.App.Containers = window.App.Containers || {};

	const ROUTES = {
		riverRaceLog: "{{ path('app_clan_stats_riverRaceLog') }}" ,
		historiqueClanWar: "{{ path('app_clan_stats_historiqueClanWar') }}" };
	const divRespSort = ["response-nom-clan-form","response-clan-info-table", "response-tag-clan", "response-historique-clan-war", "response-historique-clan-war-ex"];

	window.App.Containers = {
    get nomClanForm() { return document.getElementById("response-nom-clan-form"); },
    get tagClan() { return document.getElementById("response-tag-clan"); },
    get clanInfoTable() { return document.getElementById("response-clan-info-table"); },
    get historiqueClanWar() { return document.getElementById("response-historique-clan-war"); },
    get historiqueClanWarEx() { return document.getElementById("response-historique-clan-war-ex"); }
	};

	const AJAX_CONFIG = {
		headers: {
			"X-Requested-With": "XMLHttpRequest",
			"Content-Type": "application/json",
		},
		method: "POST"
	};

	/**
	 * @function window.App.Tools.testSelector
	 * @param {(string|Element)} selector
	 * @returns {Element|false}
	 */
	window.App.Tools.testSelector = function (selector) {
		let target = null;
		if (typeof selector === "string") {
			target = document.querySelector(selector);
		} else if (selector instanceof Element) {
			target = selector;
		} else {
			console.error("Sélecteur invalide:", selector);
			return false;
		}
		if (!target) {
			console.error("Élément non trouvé:", selector);
			return false;
		}
		return target;
	};

	/**
	 * @function window.App.toggleDisabledButton
	 * @param {(string|Element)} selector
	 * @returns {void}
	 */
	window.App.toggleDisabledButton = (function () {
		const selectorStates = new Map();
		return function(selector) {
			let target = null;
			target = App.Tools.testSelector(selector);
			if (target) {
				if (!selectorStates.has(target)) {
					selectorStates.set(target, { originalText: target.innerHTML });
				}
				if (!target.disabled) {
					target.disabled = true;
					target.innerHTML ="<span class='spinner-border spinner-border-sm' role='status' aria-hidden='true'></span> Chargement...";
				} else {
					target.disabled = false;
					target.innerHTML = selectorStates.get(target).originalText;
				}
			} else {
				return false;
			}
		};
	})();

	/**
	 * @function window.App.emptyRespDivsAfter
	 * @param {(string|Element)} selector
	 * @param {boolean} [inclusive=false]
	 * @returns {void}
	 */
	window.App.emptyRespDivsAfter = function (selector, inclusive = false) {
		let target = null;
		target = App.Tools.testSelector(selector);
		let reversedDivRespSort = [...divRespSort].reverse();
		for (let i = 0; i < reversedDivRespSort.length; i++) {
			let divElement = document.getElementById(reversedDivRespSort[i]);
			if (!divElement) continue;
			if (divElement === target) {
				if (inclusive) {
					divElement.innerHTML = "";
				}
				return true;
			} else {
				divElement.innerHTML = "";
			}
		}
	};

	function handleClanRiverRaceLog(event) {
		let callClanRiverRaceLog = event.target.closest("[data-action^='clanRiverRaceLog#call']");
		if	(!callClanRiverRaceLog) return false;
		event.preventDefault();
		let clanTag = callClanRiverRaceLog.getAttribute("data-clan-tag");
		if (!clanTag) {
        	console.warn("Clan tag manquant");
        	return true;
    	}
		App.toggleDisabledButton(callClanRiverRaceLog);
		let url = ROUTES.riverRaceLog;
		let options = {
			...AJAX_CONFIG,
			body: JSON.stringify(clanTag), // Uniquement pour POST/PUT
		};
		fetch(url, options)
			.then((response) => {
				if (!response.ok) {
					throw new Error("Erreur réseau");
				}
				App.emptyRespDivsAfter(App.Containers.clanInfoTable);
				return response.json();
			})
			.then((data) => {
				if (data.success) {
					console.log("data.success" + url);
					App.Containers.clanInfoTable.innerHTML = data.htmlClan;
					App.Containers.tagClan.innerHTML = data.htmlRiverRaceLogs;
					App.Containers.clanInfoTable.scrollIntoView({ behavior: 'smooth' });
				} else {
					if (data.errors) {
						console.log(data.errors);
					}
				}
			})
			.catch((error) => {})
			.finally(() => {
				App.toggleDisabledButton(callClanRiverRaceLog);
			});
		return true;
	}

	function handleToggleShowTarget(event) {
		let togglerShowTarget = event.target.closest("[data-action$='#togglerShow']");
		if	(!togglerShowTarget) return false;
		event.preventDefault();
		let idTargetToggler = togglerShowTarget.getAttribute("data-target-toggler");
		if (!idTargetToggler) {
			console.warn("❌ Attribut 'data-target-toggler' manquant sur l'élément:", togglerShowTarget);
        	return true;
    	}
		let targetToggler = document.getElementById(idTargetToggler);
		if (!targetToggler) {
        	console.warn(`❌ Élément cible '${idTargetToggler}' non trouvé`);
        	return true;
    	}
		let isHidden = targetToggler.hasAttribute("hidden") || targetToggler.hidden;
		if (isHidden) {
			targetToggler.removeAttribute("hidden");
			targetToggler.hidden = false;
			togglerShowTarget.textContent = "-";
		} else {
			targetToggler.setAttribute("hidden", "");
			targetToggler.hidden = true;
			togglerShowTarget.textContent = "+";
		}
		return true;
	}

	function handleHistoriqueCheckboxAll(event) {
		if (event.target.id !== 'HC_all') return false;
		let HistoriqueCheckboxAll = document.getElementById('HC_all');
		if	(!HistoriqueCheckboxAll) return false;
		const checkboxes = document.querySelectorAll('input[type="checkbox"][name="historiqueCheckbox"]');

		checkboxes.forEach(checkbox => {
			checkbox.checked = HistoriqueCheckboxAll.checked;
		});
	}

	function handleHistoriqueClanWar(event) {
		let callHistoriqueClanWar = event.target.closest("[data-action^='historiqueClanWar#call']");
		if	(!callHistoriqueClanWar) return false;
		event.preventDefault();
		let clanTag = callHistoriqueClanWar.getAttribute("data-clan-tag");
		if (!clanTag) {
			console.warn("Clan tag manquant");
			return true;
		}
		let allCheckedHCW = document.querySelectorAll('input[type="checkbox"][name="historiqueCheckbox"]:checked');
		if (allCheckedHCW.length === 0) {
			console.warn("Aucun checkbox coché");
			return true;
		}
		let warsSelected = [];
		for (let i = 0; i < allCheckedHCW.length; i++) {
			warsSelected.push(allCheckedHCW[i].value);
		}
		App.toggleDisabledButton(callHistoriqueClanWar);
		let url = ROUTES.historiqueClanWar;
		let options = {
			...AJAX_CONFIG,
			body: JSON.stringify({ clanTag, warsSelected }), // Uniquement pour POST/PUT
		};
		fetch(url, options)
			.then((response) => {
				if (!response.ok) {
					throw new Error("Erreur réseau");
				}
				App.emptyRespDivsAfter(App.Containers.historiqueClanWar);
				return response.json();
			})
			.then((data) => {
				if (data.success) {
					console.log("data.success" + url);
					App.Containers.historiqueClanWar.innerHTML = data.htmlHistorique;
					App.Containers.historiqueClanWarEx.innerHTML = data.htmlHistoriqueEx;
					App.Containers.historiqueClanWar.scrollIntoView({ behavior: 'smooth' });
				} else {
					if (data.errors) {
						console.log(data.errors);
					}
				}
			})
			.catch((error) => {})
			.finally(() => {
				App.toggleDisabledButton(callHistoriqueClanWar);
			});
		return true;
	}
/*
	document.addEventListener("DOMContentLoaded", function () {
		let form = document.getElementById("nom-clan-form");
		let submitButton = form.querySelector("button[type='submit']");

		document.addEventListener("click", function (event) {
    		handleClanRiverRaceLog(event) ||
    		handleToggleShowTarget(event) ||
    		handleHistoriqueClanWar(event);
		});

		document.addEventListener("change", function (event) {
    		handleHistoriqueCheckboxAll(event);
		});

		form.addEventListener("submit", function (event) {
			event.preventDefault(); // Empêche la soumission standard du formulaire
			App.toggleDisabledButton(submitButton);
			let formData = new FormData(form);
			fetch(form.action, {
				method: "POST",
				headers: {
					"X-Requested-With": "XMLHttpRequest",
				},
				body: formData,
			})
				.then((response) => {
					if (!response.ok) {
						throw new Error("Erreur réseau");
					}
					App.emptyRespDivsAfter(App.Containers.nomClanForm);
					return response.json();
				})
				.then((data) => {
					if (data.success) {
						console.log("data.success Form");
						App.Containers.nomClanForm.innerHTML = data.htmlSearchClans;
						App.Containers.nomClanForm.scrollIntoView({ behavior: 'smooth' });
						form.reset();
					} else {
						// Si des erreurs de validation sont présentes
						if (data.errors) {
							console.log("data.errors Form");
							console.log(data.errors);
							// Afficher les erreurs sous les champs correspondants
							for (const field in data.errors) {
								console.log("data.errors Form field");
								console.log(field);
							}
						}
					}
				})
				.catch((error) => {
					// Erreur technique
					App.Containers.nomClanForm.innerHTML = `<div class="alert alert-danger">Une erreur est survenue: ${error.message}</div>`;
				})
				.finally(() => {
					App.toggleDisabledButton(submitButton);
				});
		});
	}); */
</script>
{% endblock %}
